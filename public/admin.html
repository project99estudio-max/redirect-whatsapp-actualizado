<script>
// ===== Fondo part√≠culas =====
const c=document.getElementById("bg"),x=c.getContext("2d");
let P=[];
function rs(){c.width=innerWidth;c.height=innerHeight}
addEventListener("resize",rs);rs();
for(let i=0;i<90;i++){
  P.push({x:Math.random()*c.width,y:Math.random()*c.height,vx:(Math.random()-.5)*.28,vy:(Math.random()-.5)*.28,r:Math.random()*2+.7});
}
(function anim(){
  const grad=x.createRadialGradient(c.width*0.3,c.height*0.1,0,c.width*0.3,c.height*0.1,Math.max(c.width,c.height));
  const cs=p=>getComputedStyle(document.documentElement).getPropertyValue(p).trim();
  grad.addColorStop(0,cs('--bg1'));grad.addColorStop(1,cs('--bg2'));
  x.fillStyle=grad;x.fillRect(0,0,c.width,c.height);x.fillStyle=cs('--particle');
  for(const p of P){
    p.x+=p.vx;p.y+=p.vy;
    if(p.x<0||p.x>c.width)p.vx*=-1;
    if(p.y<0||p.y>c.height)p.vy*=-1;
    x.beginPath();x.arc(p.x,p.y,p.r,0,Math.PI*2);x.fill();
  }
  requestAnimationFrame(anim);
})();

// ===== Panel =====
const $=s=>document.querySelector(s);
const list=$("#list"),msg=$("#msg"),tokenInput=$("#token"),bsInput=$("#blocksize"),saveWrap=$("#saveWrap");

function row(val={name:"",url:""}) {
  if(typeof val==="string") val={name:"",url:val};
  const d=document.createElement("div");d.className="item";
  const iName=document.createElement("input");iName.type="text";iName.placeholder="Nombre";iName.className="name";iName.value=val.name||"";
  const iUrl=document.createElement("input");iUrl.type="text";iUrl.placeholder="https://wa.me/...";iUrl.className="url";iUrl.value=val.url||"";
  const b=document.createElement("button");b.className="btn btn--thin btn--sm";b.textContent="Borrar";b.onclick=()=>d.remove();
  d.append(iName,iUrl,b);list.append(d);
}
function values(){
  return [...list.querySelectorAll(".item")].map(el=>{
    const name=el.querySelector(".name")?.value.trim()||"";
    const url=el.querySelector(".url")?.value.trim()||"";
    return url?{name,url}:null;
  }).filter(Boolean);
}
function show(t,ok=1){msg.textContent=t;msg.className=ok?"ok":"err"}

$("#btnSaveToken").onclick=()=>{localStorage.setItem("adm_tok",tokenInput.value.trim());show("Token guardado")};

window.onload=async()=>{
  const t=localStorage.getItem("adm_tok");
  if(t) tokenInput.value=t;
  if(t){ await loadBlockSize(t); }
};

$("#btnView").onclick=async()=>{
  const t=tokenInput.value.trim();if(!t)return show("Pon√© token",0);
  try{
    show("Cargando...");
    const r=await fetch(`/api/admin?token=${encodeURIComponent(t)}&get=1`);
    const j=await r.json();
    list.innerHTML="";(j.links||[]).forEach(o=>row(o));
    if((j.links||[]).length===0)row();
    show("Lista cargada");
    // üëá Mostrar bot√≥n Guardar al ver la lista
    const saveWrap=document.getElementById("saveWrap");
    if(saveWrap) saveWrap.style.display="flex";
  }catch(e){show("Error al cargar",0);}
};

$("#btnReset").onclick=async()=>{
  const t=tokenInput.value.trim();if(!t)return show("Pon√© token",0);
  try{
    const r=await fetch(`/api/admin?token=${encodeURIComponent(t)}&reset=1`);
    const j=await r.json();list.innerHTML="";row();
    show(j.ok?"Lista borrada":"Error",j.ok);
  }catch(e){show("Error",0);}
};

$("#btnRot").onclick=async()=>{
  const t=tokenInput.value.trim();if(!t)return show("Pon√© token",0);
  try{
    const r=await fetch(`/api/rotate-reset?token=${encodeURIComponent(t)}`);
    const j=await r.json();show(j.ok?"Rotaci√≥n reiniciada":"Error",j.ok);
  }catch(e){show("Error",0);}
};

// üëá Al agregar una cajera tambi√©n aparece el bot√≥n Guardar
$("#btnAdd").onclick=()=>{
  row();
  const saveWrap=document.getElementById("saveWrap");
  if(saveWrap) saveWrap.style.display="flex";
};

$("#btnSaveFinal").onclick=async()=>{
  const t=tokenInput.value.trim();if(!t)return show("Pon√© token",0);
  const vals=values();if(!vals.length)return show("Nada que guardar",0);
  try{
    show("Guardando...");
    const r=await fetch(`/api/admin-post?token=${encodeURIComponent(t)}`,{
      method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(vals)
    });
    const j=await r.json();show(j.ok?`Guardado (${j.saved})`:"Error al guardar",j.ok);
  }catch(e){show("Error al guardar",0);}
};

async function loadBlockSize(t){
  try{
    const r=await fetch(`/api/blocksize?token=${encodeURIComponent(t)}&get=1`);
    const j=await r.json();if(j.ok&&j.value!==undefined)bsInput.value=j.value;
  }catch(e){}
}

$("#btnSaveBS").onclick=async()=>{
  const t=tokenInput.value.trim();if(!t)return show("Pon√© token",0);
  const v=Number(bsInput.value);
  if(!Number.isInteger(v)||v<1||v>20)return show("Valor inv√°lido (1 a 20)",0);
  try{
    const r=await fetch(`/api/blocksize?token=${encodeURIComponent(t)}`,{
      method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({value:v})
    });
    const j=await r.json();show(j.ok?`Block size guardado (${v})`:"Error al guardar",j.ok);
  }catch(e){show("Error al guardar",0);}
};

$("#btnStats").onclick=()=>show("üìä Pr√≥ximamente: Conteo de mensajes y m√©tricas.",1);
</script>
